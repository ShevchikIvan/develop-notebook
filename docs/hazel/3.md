开发日记（二）集群通讯进阶设计
-------------------------
经过上一版本的大翻新后，原本设计好的集群通讯，尽管能用，但并不理想。

原先设计的集群通讯图如下所示：

![原集群通讯图](../images/cluster-communication-design.png)

假设有n个节点则要维护n(n-1)/2条连接，这种设计会耗费相当多的网络资源。而且这只是理想情况，实际在应用中的连接数可能会翻一番，也就是n(n-1)条，因为理想设计对于开发维护的难度较大，所以通常会使用单通道的tcp连接，如此一来，上图中每一条线就代表两条连接了。

一个比较容易想到的优化模型，就是消息队列的方式了，但这究竟是否算是优化，其实还得打个疑问，至少对于初学golang的我来说，亲自实现一个消息队列，会是件很有意思的事哈。

我要实现的消息队列，肯定不能太复杂，能完成基本功能就好。

#### 2015年11月27日 下午11:02
今天有事耽搁了，只修复了些bug，以及用redis重写了chatroom。我其实觉得hazel本身支不支持redis都无所谓，反正我又没有集成orm等便利数据库功能，要用的话直接用就是了，包括postgresql也是一样。

bug包括以下几点：
- 修复了session机制中存在的bug，由于message都是通过指针传递，导致在这期间误修改了message实际内容。
- 修复了事件响应中若不通过message manager，而直接调用自身函数而导致的与session相关的错误，这个事件中正好涉及到session。

对于redis的使用，我采用的是[garyburd/redigo/redis]("github.com/garyburd/redigo/redis")，不是很便捷，从redis中获取到的数据还得转换类型，包括用了连接池，但却没有相关直接通过连接吃调用的函数。

此外对于redis的设计并不是很懂，看以前做chrome插件时阿翔写的代码，照搬着用吧，功能是勉强实现，Orz..调试了半天额!

今天基本就是这样了，明天早起可以集群通讯和docker部署两步走了，毕竟多了个redis服务了，由于时间关系..最好先把docker再玩玩好，集群通讯这块的设计，逼近之前已经搞过，完善什么的以后再说也行哈！
